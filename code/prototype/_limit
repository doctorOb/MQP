#!/bin/bash

function getIP() {
	A="/inet/ && /$1/";
	B='{sub(/\/.*$/,"",$2); print $2}';
	ip addr | awk "$A$B";
}
function ba_limit() {
	ETH=$1;
	LIMIT=$2;
	ETH_IP=$(getIP $ETH);
	sudo tc qdisc add dev $ETH root handle 1: htb default 10;
	sudo tc class add dev $ETH parent 1: classid 1:1 htb rate 50000kbps ceil 50000kbps ;
	sudo tc class add dev $ETH parent 1:1 classid 1:10 htb rate $LIMIT ceil $LIMIT;
	sudo tc class add dev $ETH parent 1:1 classid 1:11 htb rate $LIMIT ceil $LIMIT;
	sudo tc filter add dev $ETH protocol ip parent 1:0 prio 1 u32 match ip dst ${ETH_IP};
}

function balim() {
	#from http://lartc.org/lartc.html#LARTC.RATELIMIT.SINGLE
	ETH=$1;
	LIMIT=$2;
	ETH_IP=$(getIP $ETH);

	#sudo tc qdisc add dev $ETH root tbf rate $LIMIT latency 50ms burst 1540;

	sudo tc qdisc add dev $ETH root handle 1: htb;
	sudo tc class add dev $ETH parent 1: classid 1:2 htb rate $LIMIT ceil $LIMIT burst 1Mb cburst 1Mb;
	sudo tc filter add dev $ETH protocol ip parent 1: prio 1 u32 match ip dst $ETH_IP flowid 1:2;

}

function tc_clear() {
	sudo tc qdisc del dev $1 root;
}


alias test="curl --interface eth2 http://10.18.234.114/stuff/space.jpg > /dev/null";